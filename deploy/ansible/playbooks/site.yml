---
# Main orchestration playbook for CrowdTowers
#
# For initial setup (as root):
#   ansible-playbook playbooks/site.yml --extra-vars "ansible_user=root" --ask-vault-pass
#
# For subsequent runs (as deploy user):
#   ansible-playbook playbooks/site.yml --ask-vault-pass
#
# Deploy specific environment:
#   ansible-playbook playbooks/site.yml --ask-vault-pass -l crowdtowers-prod
#   ansible-playbook playbooks/site.yml --ask-vault-pass -l crowdtowers-staging
#
# Run specific tasks with tags:
#   ansible-playbook playbooks/site.yml --ask-vault-pass --tags deploy

# =============================================================================
# Play 1: Infrastructure setup (runs ONCE on the server)
# =============================================================================
- name: Server Infrastructure Setup
  hosts: all
  become: yes
  run_once: true

  vars_files:
    - ../inventory/group_vars/all/vault.yml

  handlers:
    - name: Restart fail2ban
      systemd:
        name: fail2ban
        state: restarted

    - name: Restart sshd
      systemd:
        name: sshd
        state: restarted

    - name: Restart MongoDB
      systemd:
        name: mongod
        state: restarted

  tasks:
    - name: Include initial setup
      ansible.builtin.include_tasks: initial-setup.yml
      tags: [setup, initial]

    - name: Include security hardening
      ansible.builtin.include_tasks: security.yml
      tags: [setup, security]

    - name: Include MongoDB setup
      ansible.builtin.include_tasks: mongodb.yml
      tags: [setup, mongodb]

    - name: Include Node.js setup
      ansible.builtin.include_tasks: nodejs.yml
      tags: [setup, nodejs]

# =============================================================================
# Play 2: Per-app deployment (runs for EACH environment)
# =============================================================================
- name: Application Deployment
  hosts: all
  become: yes
  serial: 1  # Run one at a time to avoid conflicts

  vars_files:
    - ../inventory/group_vars/all/vault.yml

  handlers:
    - name: Reload Nginx
      systemd:
        name: nginx
        state: reloaded

  tasks:
    - name: Include Nginx setup
      ansible.builtin.include_tasks: nginx.yml
      tags: [setup, nginx]

    - name: Include application deployment
      ansible.builtin.include_tasks: deploy-app.yml
      tags: [deploy]
