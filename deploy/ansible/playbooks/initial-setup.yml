---
# Initial server setup tasks

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Upgrade all packages
  apt:
    upgrade: dist
    autoremove: yes

- name: Install essential packages
  apt:
    name:
      - curl
      - wget
      - git
      - htop
      - vim
      - ufw
      - unzip
      - build-essential
      - python3-pip
      - acl
      - unattended-upgrades
      - apt-listchanges
    state: present

- name: Set timezone to UTC
  timezone:
    name: UTC

- name: Create deploy user
  user:
    name: deploy
    shell: /bin/bash
    groups: sudo
    append: yes
    create_home: yes
    password: "{{ vault_deploy_user_password | password_hash('sha512') }}"

- name: Create .ssh directory for deploy user
  file:
    path: /home/deploy/.ssh
    state: directory
    owner: deploy
    group: deploy
    mode: '0700'

- name: Add SSH key for deploy user
  authorized_key:
    user: deploy
    key: "{{ lookup('file', '~/.ssh/crowdtowers_deploy.pub') }}"
    state: present

- name: Allow deploy user passwordless sudo for specific commands
  copy:
    content: |
      deploy ALL=(ALL) NOPASSWD: /usr/bin/pm2
      deploy ALL=(ALL) NOPASSWD: /usr/bin/npm
      deploy ALL=(ALL) NOPASSWD: /bin/systemctl restart nginx
      deploy ALL=(ALL) NOPASSWD: /bin/systemctl reload nginx
    dest: /etc/sudoers.d/deploy
    owner: root
    group: root
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Create application directory
  file:
    path: "{{ app_path }}"
    state: directory
    owner: deploy
    group: deploy
    mode: '0755'

- name: Create PM2 log directory
  file:
    path: /var/log/pm2
    state: directory
    owner: deploy
    group: deploy
    mode: '0755'

# Automatic security updates with auto-reboot at 02:00
- name: Configure unattended-upgrades
  copy:
    content: |
      Unattended-Upgrade::Allowed-Origins {
          "${distro_id}:${distro_codename}";
          "${distro_id}:${distro_codename}-security";
          "${distro_id}ESMApps:${distro_codename}-apps-security";
          "${distro_id}ESM:${distro_codename}-infra-security";
      };
      Unattended-Upgrade::Package-Blacklist {
      };
      Unattended-Upgrade::DevRelease "auto";
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::MinimalSteps "true";
      Unattended-Upgrade::InstallOnShutdown "false";
      Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
      Unattended-Upgrade::Remove-New-Unused-Dependencies "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "true";
      Unattended-Upgrade::Automatic-Reboot-Time "02:00";
      Unattended-Upgrade::Automatic-Reboot-WithUsers "true";
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: '0644'

- name: Enable automatic updates
  copy:
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::Download-Upgradeable-Packages "1";
      APT::Periodic::AutocleanInterval "7";
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    owner: root
    group: root
    mode: '0644'

- name: Enable unattended-upgrades service
  systemd:
    name: unattended-upgrades
    enabled: yes
    state: started
